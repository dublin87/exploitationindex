###################################################################################################
# Setup & Packages
###################################################################################################

install.packages("pacman")

#packages_v <- c("here", "tidyverse", "sf", "rvest", "jsonlite",    
               # "httr", "pacman", "tictoc", "pryr", "tigris", "tidycensus","rgdal","Matching", 
               # "raster", "stargazer","zoo","MASS","ggrepel","ggthemes","ggpmisc","ggpubr", "raster","rgdal","MatchIt","cobalt","cowplot","rgenoud", "mapview","modelsummary","plm","ggmap","bea.R") 

pacman::p_unload(pacman::p_loaded(), character.only = TRUE)

packages_simple  <- c("tidyverse","bea.R","tigris", "tidycensus")

pacman::p_load(char = packages_simple)

#### Set Working Directory on my own computer. This is the top level of the "nesting dolls" used by R for file organization.

### PC directory 
setwd("C:/Users/nickv/OneDrive/Documents/exploitationindex")

### Mac directory 
# setwd()

### Set main directory for file organization

main_dir <- "C:/Users/nickv/OneDrive/Documents/exploitationindex"
output <- "output" 


#### Load census API key 
census_api_key("1d2602068db46e014dbf54a7c7e195cb8f417e61", install = TRUE, overwrite = TRUE)

#### Load BEA API key
beaKey <- "7542C708-5E9D-4740-A5C2-23508B5E62C3"

use_git_config(user.name = "Nick", user.email = "nickvmessenger@gmail.com")

###########################################################################################################
# How to determine the necessary linecode from BEA tables
###########################################################################################################

### Search the BEA for datasets containing variables, if needed:
head(beaSearch("population", beaKey = beaKey))

# Retrieve linecodes as dataframe
linecode <- beaParamVals(beaKey = beaKey, "Regional", "LineCode")$ParamValue

# Inspect the dataset
glimpse(linecode)

# The table names are available in the first parts of the "Desc" column

# Filter using str_detect() and identify the linecodes. Replace "CAEMP25N" with whichever table from the BEA is appropriate. You can find a table list here: https://apps.bea.gov/regional/downloadzip.cfm

linecode %>% filter(str_detect(Desc, "CAINC1"))

###########################################################################################################
# Pull BEA data by county 
###########################################################################################################

#### Load BEA API key
beaKey <- "7542C708-5E9D-4740-A5C2-23508B5E62C3"

specs_1 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAGDP2", # Specify table within the dataset
  "LineCode" = '1', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea1 <- beaGet(specs_1, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea1 <- bea1 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(total_gdp = DataValue,
         county = GeoName)

### Repeat with remaining variables:

specs_2 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAGDP2", # Specify table within the dataset
  "LineCode" = '2', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea2 <- beaGet(specs_2, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea2 <- bea2 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(private_gdp = DataValue,
         county = GeoName)

############################

specs_3 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAGDP2", # Specify table within the dataset
  "LineCode" = '11', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea3 <- beaGet(specs_3, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea3 <- bea3 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(construction_gdp = DataValue,
         county = GeoName)

############################

specs_4 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAGDP2", # Specify table within the dataset
  "LineCode" = '3', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea4 <- beaGet(specs_4, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea4 <- bea4 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(agriculture_gdp = DataValue,
         county = GeoName)

############################

specs_5 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAGDP2", # Specify table within the dataset
  "LineCode" = '6', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea5 <- beaGet(specs_5, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea5 <- bea5 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(mining_gdp = DataValue,
         county = GeoName)

############################

specs_6 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAGDP2", # Specify table within the dataset
  "LineCode" = '10', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea6 <- beaGet(specs_6, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea6 <- bea6 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(utilities_gdp = DataValue,
         county = GeoName)

############################

specs_7 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAGDP2", # Specify table within the dataset
  "LineCode" = '13', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea7 <- beaGet(specs_7, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea7 <- bea7 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(durable_gdp = DataValue,
         county = GeoName)

############################

specs_8 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAGDP2", # Specify table within the dataset
  "LineCode" = '25', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea8 <- beaGet(specs_8, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea8 <- bea8 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(nondurable_gdp = DataValue,
         county = GeoName)

############################

specs_9 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAGDP2", # Specify table within the dataset
  "LineCode" = '34', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea9 <- beaGet(specs_9, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea9 <- bea9 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(wholesaletrade_gdp = DataValue,
         county = GeoName)

############################

specs_10 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAGDP2", # Specify table within the dataset
  "LineCode" = '35', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea10 <- beaGet(specs_10, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea10 <- bea10 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(retailtrade_gdp = DataValue,
         county = GeoName)

############################

specs_11 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAGDP2", # Specify table within the dataset
  "LineCode" = '36', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea11 <- beaGet(specs_11, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea11 <- bea11 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(transport_warehouse_gdp = DataValue,
         county = GeoName)

############################

specs_12 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAGDP2", # Specify table within the dataset
  "LineCode" = '45', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea12 <- beaGet(specs_12, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea12 <- bea12 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(information_gdp = DataValue,
         county = GeoName)

############################

specs_13 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAGDP2", # Specify table within the dataset
  "LineCode" = '51', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea13 <- beaGet(specs_13, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea13 <- bea13 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(finance_insurance_gdp = DataValue,
         county = GeoName)

############################

specs_14 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAGDP2", # Specify table within the dataset
  "LineCode" = '56', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea14 <- beaGet(specs_14, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea14 <- bea14 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(realestate_gdp = DataValue,
         county = GeoName)

############################

specs_15 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAGDP2", # Specify table within the dataset
  "LineCode" = '60', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea15 <- beaGet(specs_15, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea15 <- bea15 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(science_tech_gdp = DataValue,
         county = GeoName)

############################

specs_16 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAGDP2", # Specify table within the dataset
  "LineCode" = '64', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea16 <- beaGet(specs_16, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea16 <- bea16 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(management_gdp = DataValue,
         county = GeoName)

############################

specs_17 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAGDP2", # Specify table within the dataset
  "LineCode" = '59', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea17 <- beaGet(specs_17, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea17 <- bea17 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(businessservice_gdp = DataValue,
         county = GeoName)

############################

specs_18 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAGDP2", # Specify table within the dataset
  "LineCode" = '69', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea18 <- beaGet(specs_18, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea18 <- bea18 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(edservices_gdp = DataValue,
         county = GeoName)

############################

specs_19 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAGDP2", # Specify table within the dataset
  "LineCode" = '70', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea19 <- beaGet(specs_19, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea19 <- bea19 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(healthcare_gdp = DataValue,
         county = GeoName)

############################

specs_20 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAGDP2", # Specify table within the dataset
  "LineCode" = '76', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea20 <- beaGet(specs_20, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea20 <- bea20 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(recreation_gdp = DataValue,
         county = GeoName)

############################

specs_21 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAGDP2", # Specify table within the dataset
  "LineCode" = '79', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea21 <- beaGet(specs_21, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea21 <- bea21 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(hosp_food_gdp = DataValue,
         county = GeoName)

############################

specs_22 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAGDP2", # Specify table within the dataset
  "LineCode" = '82', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea22 <- beaGet(specs_22, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea22 <- bea22 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(other_gdp = DataValue,
         county = GeoName)

############################

specs_23 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAGDP2", # Specify table within the dataset
  "LineCode" = '83', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea23 <- beaGet(specs_23, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea23 <- bea23 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(government_gdp = DataValue,
         county = GeoName)

############################

specs_24 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAINC5N", # Specify table within the dataset
  "LineCode" = '10', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea24 <- beaGet(specs_24, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea24 <- bea24 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(personal_income = DataValue,
         county = GeoName)

############################

specs_25 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAINC5N", # Specify table within the dataset
  "LineCode" = '42', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea25 <- beaGet(specs_25, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea25 <- bea25 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(adjustment_residence = DataValue,
         county = GeoName)

############################

specs_26 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAINC5N", # Specify table within the dataset
  "LineCode" = '45', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea26 <- beaGet(specs_26, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea26 <- bea26 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(netearnings_placeofresidence = DataValue,
         county = GeoName)

############################

specs_27 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAINC5N", # Specify table within the dataset
  "LineCode" = '47', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea27 <- beaGet(specs_27, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea27 <- bea27 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(personal_transfer_receipts = DataValue,
         county = GeoName)

############################

specs_28 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAINC5N", # Specify table within the dataset
  "LineCode" = '50', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea28 <- beaGet(specs_28, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea28 <- bea28 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(wages_salaries = DataValue,
         county = GeoName)

############################

specs_29 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAINC5N", # Specify table within the dataset
  "LineCode" = '70', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea29 <- beaGet(specs_29, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea29 <- bea29 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(proprietors_income = DataValue,
         county = GeoName)

############################

specs_30 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAINC5N", # Specify table within the dataset
  "LineCode" = '100', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea30 <- beaGet(specs_30, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea30 <- bea30 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(forestry_pi = DataValue,
         county = GeoName)

############################

specs_31 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAINC5N", # Specify table within the dataset
  "LineCode" = '200', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea31 <- beaGet(specs_31, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea31 <- bea31 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(mining_pi = DataValue,
         county = GeoName)

############################

specs_32 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAINC5N", # Specify table within the dataset
  "LineCode" = '300', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea32<- beaGet(specs_32, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea32 <- bea32 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(utilities_pi = DataValue,
         county = GeoName)

############################

specs_33 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAINC5N", # Specify table within the dataset
  "LineCode" = '400', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea33 <- beaGet(specs_33, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea33 <- bea33 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(construction_pi = DataValue,
         county = GeoName)

############################

specs_34 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAINC5N", # Specify table within the dataset
  "LineCode" = '510', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea34 <- beaGet(specs_34, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea34 <- bea34 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(durablegoods_pi = DataValue,
         county = GeoName)

############################

specs_35 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAINC5N", # Specify table within the dataset
  "LineCode" = '530', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea35 <- beaGet(specs_35, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea35 <- bea35 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(nondurable_pi = DataValue,
         county = GeoName)

############################

specs_36 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAINC5N", # Specify table within the dataset
  "LineCode" = '600', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea36 <- beaGet(specs_36, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea36 <- bea36 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(wholesale_pi = DataValue,
         county = GeoName)

############################

specs_37 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAINC5N", # Specify table within the dataset
  "LineCode" = '700', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea37 <- beaGet(specs_37, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea37 <- bea37 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(retail_pi = DataValue,
         county = GeoName)

############################

specs_38 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAINC5N", # Specify table within the dataset
  "LineCode" = '800', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea38 <- beaGet(specs_38, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea38 <- bea38 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(transport_warehouse_pi = DataValue,
         county = GeoName)

############################

specs_39 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAINC5N", # Specify table within the dataset
  "LineCode" = '900', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea39 <- beaGet(specs_39, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea39 <- bea39 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(information_pi = DataValue,
         county = GeoName)

############################

specs_40 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAINC5N", # Specify table within the dataset
  "LineCode" = '1000', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea40 <- beaGet(specs_40, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea40 <- bea40 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(finance_insurance_pi = DataValue,
         county = GeoName)

############################

specs_41 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAINC5N", # Specify table within the dataset
  "LineCode" = '1100', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea41 <- beaGet(specs_41, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea41<- bea41 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(realestate_pi = DataValue,
         county = GeoName)

############################

specs_42 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAINC5N", # Specify table within the dataset
  "LineCode" = '1200', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea42 <- beaGet(specs_42, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea42 <- bea42 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(science_tech_pi = DataValue,
         county = GeoName)

############################

specs_43 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAINC5N", # Specify table within the dataset
  "LineCode" = '1300', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea43 <- beaGet(specs_43, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea43 <- bea43 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(management_pi = DataValue,
         county = GeoName)

############################

specs_44 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAINC5N", # Specify table within the dataset
  "LineCode" = '1401', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea44 <- beaGet(specs_44, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea44 <- bea44 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(administration_pi = DataValue,
         county = GeoName)

############################

specs_45 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAINC5N", # Specify table within the dataset
  "LineCode" = '1500', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea45 <- beaGet(specs_45, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea45 <- bea45 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(edservices_pi = DataValue,
         county = GeoName)

############################

specs_46 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAINC5N", # Specify table within the dataset
  "LineCode" = '1600', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea46 <- beaGet(specs_46, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea46 <- bea46 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(healthcare_pi = DataValue,
         county = GeoName)

############################

specs_47 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAINC5N", # Specify table within the dataset
  "LineCode" = '1700', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea47 <- beaGet(specs_47, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea47 <- bea47 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(recreation_pi = DataValue,
         county = GeoName)

############################

specs_48 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAINC5N", # Specify table within the dataset
  "LineCode" = '1800', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea48 <- beaGet(specs_48, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea48 <- bea48 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(food_pi = DataValue,
         county = GeoName)

############################

specs_49 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAINC5N", # Specify table within the dataset
  "LineCode" = '1900', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea49 <- beaGet(specs_49, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea49 <- bea49 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(other_pi = DataValue,
         county = GeoName)

############################

specs_50 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAINC5N", # Specify table within the dataset
  "LineCode" = '2000', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea50 <- beaGet(specs_50, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea50 <- bea50 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(government_pi = DataValue,
         county = GeoName)

############################

specs_51 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAINC1", # Specify table within the dataset
  "LineCode" = '2', # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = '2021',
  "ResultFormat" = 'json'# Specify the year
)

### Use specs to create dataframe
bea51 <- beaGet(specs_51, asWide = FALSE)

### Delete extraneous columns and rename variables within the data frame
bea51 <- bea51 %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  rename(population = DataValue,
         county = GeoName)



# Join three datasets
data <- bea1 %>% 
  left_join(., select(bea2, private_gdp, GeoFips), by = "GeoFips") %>% 
  left_join(., select(bea3, construction_gdp, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea4, agriculture_gdp, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea5, mining_gdp, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea6, utilities_gdp, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea7, durable_gdp, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea8, nondurable_gdp, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea9, wholesaletrade_gdp, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea10, retailtrade_gdp, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea11, transport_warehouse_gdp, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea12, information_gdp, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea13, finance_insurance_gdp, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea14, realestate_gdp, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea15, science_tech_gdp, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea16, management_gdp, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea17, businessservice_gdp, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea18, edservices_gdp, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea19, healthcare_gdp, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea20, recreation_gdp, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea21, hosp_food_gdp, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea22, other_gdp, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea23, government_gdp, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea24, personal_income, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea25, adjustment_residence, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea26, netearnings_placeofresidence, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea27, personal_transfer_receipts, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea28, wages_salaries, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea29, proprietors_income, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea30, forestry_pi, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea31, mining_pi, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea32, utilities_pi, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea33, construction_pi, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea34, durablegoods_pi, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea35, nondurable_pi, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea36, wholesale_pi, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea37, retail_pi, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea38, transport_warehouse_pi, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea39, information_pi, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea40, finance_insurance_pi, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea41, realestate_pi, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea42, science_tech_pi, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea43, management_pi, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea44, administration_pi, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea45, edservices_pi, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea46, healthcare_pi, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea47, recreation_pi, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea48, food_pi, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea49, other_pi, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea50, government_pi, GeoFips), by = "GeoFips") %>%
  left_join(., select(bea51, population, GeoFips), by = "GeoFips") 

#########################################################
# Get median household income data from US Census
#########################################################

hh_inc <- get_acs(geography = "county", variables = "B19013_001", geometry = FALSE, year = 2021, survey = "acs5")

hh_inc <- hh_inc %>%
  rename("median_hhincome" = "estimate") %>%
  rename("GeoFips" = "GEOID")

hh_inc$median_hhincome <- as.numeric(hh_inc$median_hhincome)

hh_inc[c('county', 'state')] <- str_split_fixed(hh_inc$NAME, ',', 2)

hh_inc <- filter(hh_inc, state != " Puerto Rico")
hh_inc <- filter(hh_inc, state != " Alaska")

keeps <- c("GeoFips",'median_hhincome')

hh_inc <- hh_inc[keeps]

### Join household income data to BEA dataset

all_counties <- left_join(data, hh_inc, by = "GeoFips")

### Replace NA with (D) for disclosure notation from BEA

data[is.na(data)] = "(D)"

### Save data as csv file

write.csv(all_counties, "output/all_counties.csv")

### Randomly sample 50 counties and write new dataframe

fifty_county <- sample_n(data, 50)
write.csv(fifty_county, "output/fifty_county.csv")
