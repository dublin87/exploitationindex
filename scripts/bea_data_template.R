###################################################################################################
# Setup & Packages
###################################################################################################

install.packages("pacman")

packages_v <- c("here", "tidyverse", "sf", "rvest", "jsonlite",    
                "httr", "pacman", "tictoc", "pryr", "tigris", "tidycensus","rgdal","Matching", 
                "raster", "stargazer","zoo","MASS","ggrepel","ggthemes","ggpmisc","ggpubr", "raster","rgdal","MatchIt","cobalt","cowplot","rgenoud", "tidysynth", "mapview","modelsummary","plm","ggmap","bea.R") 
pacman::p_load(char = packages_v)

#### Set Working Directory on my own computer. This is the top level of the "nesting dolls" used by R for file organization.
setwd("C:/Users/nickv/OneDrive/Documents/exploitationindex")

#### Load census API key 
census_api_key("1d2602068db46e014dbf54a7c7e195cb8f417e61", install = TRUE, overwrite = TRUE)

#### Load BEA API key
beaKey <- "7542C708-5E9D-4740-A5C2-23508B5E62C3"

###########################################################################################################
# How to determine the necessary linecode from BEA tables
###########################################################################################################

### Search the BEA for datasets containing variables, if needed:
head(beaSearch("nonfarm proprietors", beaKey = beaKey))

# Retrieve linecodes as dataframe
linecode <- beaParamVals(beaKey = beaKey, "Regional", "LineCode")$ParamValue

# Inspect the dataset
glimpse(linecode)

# The table names are available in the first parts of the "Desc" column

# Filter using str_detect() and identify the linecodes. Replace "CAEMP25N" with whichever table from the BEA is appropriate. You can find a table list here: https://apps.bea.gov/regional/downloadzip.cfm

linecode %>% filter(str_detect(Desc, "CAGDP2"))
###########################################################################################################


beaSpecs10 <- list(
  "UserID" = beaKey, # Set up API key
  "Method" = "GetData", # Method
  "datasetname" = "Regional", # Specify dataset
  "TableName" = "CAEMP25N", # Specify table within the dataset
  "LineCode" = 10, # Specify the line code
  "GeoFips" = "COUNTY", # Specify the geographical level
  "Year" = 2018 # Specify the year
)

bea_10 <- beaGet(beaSpecs10, asWide = FALSE)
knitr::kable(head(bea_10))


bea_totalemp <- bea_10 %>% 
  filter(str_detect(GeoFips, "^48")) %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  mutate(GeoName = gsub(",.*$", "", GeoName)) %>% 
  rename(totalemp = DataValue,
         county = GeoName)